var velocity,select,songs,LEDList,bg,canvas,projectName,timer,stage,st,keyList=[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,49,50,51,52,53,54,55,56,57,48,32,96,97,98,99,100,101,102,103,104,105,111,106,109,107,110,189,187,8,219,221,220,186,222,188,190,191,192,16],url="http://127.0.0.1:9000",mobile=!1,IE=!1,opacity=",1)",keyColor=[],pressedKey=[],coloredKey=[],keyCount=[],counter=[],baseColor="#FFFFFF",strokeColor="rgba(255,255,255,0.65)",sound=[],audio=[],audioInstance=[],autoData=[],cirs=[],cirs2=[],rects=[],anim=[],drect=[],dcir=[],nowPage=0,chain=6,keyX=8,keyY=8,autoP=!1,keyTest=[];function cnv2Resize(){canvas.width=19*window.innerWidth/20,canvas.height=19*window.innerHeight/20,initBtnEL(),render()}function initBtnEL(){mobile?(canvas.removeEventListener("touchstart",Touched),canvas.addEventListener("touchstart",Touched)):(canvas.removeEventListener("click",Clicked,!1),canvas.addEventListener("click",Clicked,!1))}function collides(e,t){for(var n=!1,o=0,r=rects.length;o<r;o++){var a=rects[o].x,i=rects[o].x+rects[o].w,s=rects[o].y,c=rects[o].y+rects[o].h;if(i>=e&&a<=e&&c>=t&&s<=t){if(n=rects[o],!audio[nowPage][o][counter[nowPage][o]])return null;keyTest[nowPage][o].length>0&&keyLED1(nowPage,o,counter[nowPage][o],0),playAudio(nowPage,o)}}return n}function collides2(e,t){for(var n=!1,o=0,r=cirs.length;o<r;o++){var a=cirs[o].x,i=cirs[o].x+cirs[o].w,s=cirs[o].y,c=cirs[o].y+cirs[o].h;i>=e&&a<=e&&c>=t&&s<=t&&(n=cirs[o],nowPage=o,render())}return n}Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),n=t.length>>>0,o=arguments[1]>>0,r=o<0?Math.max(n+o,0):Math.min(o,n),a=arguments[2],i=void 0===a?n:a>>0,s=i<0?Math.max(n+i,0):Math.min(i,n);r<s;)t[r]=e,r++;return t}}),window.onload=function(){var e=!!window.opr&&!!opr.addons||!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,t=(/constructor/i.test(window.HTMLElement)||(!window.safari||"undefined"!=typeof safari&&safari.pushNotification).toString(),!!document.documentMode),n=!t&&!!window.StyleMedia;(!!window.chrome&&!!window.chrome.webstore||e)&&window.CSS;navigator.platform&&(0>"win16|win32|win64|mac".indexOf(navigator.platform.toLowerCase())?(mobile=!0,document.getElementById("Env").innerText="Mobile"):(mobile=!1,document.getElementById("Env").innerText="PC",t||n?(IE=!0,t&&alert("Audio almost not working well on IE...\nplease use other browser T^T\nSorry")):(IE=!1,createjs.Ticker.on("tick",render),createjs.Ticker.framerate=144))),canvas=document.getElementById("canv"),ctx=canvas.getContext("2d"),stage=new createjs.Stage("canv"),select=document.getElementById("Selector"),getData("./Songs",function(e){songs=e.msg;for(var t=0;t<songs.length;t++){var n=document.createElement("option");n.value=t,n.text=songs[t].split("\n")[0],select.add(n)}}),getData("./Velocity",function(e){velocity=e.msg,document.getElementById("Velocity").innerText="Velocity:Loaded"}),arrinit(),cnv2Resize(),window.addEventListener("resize",function(){clearTimeout(timer),timer=setTimeout(cnv2Resize,300)},!1)};var keysDown={};function render(){if(canvas&&stage){var e=canvas.width>canvas.height?canvas.height:canvas.width,t=e/(keyX*keyY);stage.removeChild(bg),(bg=new createjs.Shape).graphics.beginFill("#444444").drawRoundRect(t/2,t/2,canvas.width-t,canvas.height-t,t),stage.addChild(bg);for(var n=0;n<keyX*keyY;n++)rects[n]={x:canvas.width/2-keyX/2*e/(keyX+1)+e*(n%keyX)/(keyX+2),y:canvas.height/2-keyY/2*e/(keyY+2)+e*parseInt(n/keyY)/(keyY+2),w:e/(keyX+3),h:e/(keyY+3)},stage.removeChild(drect[n]),drect[n]=new createjs.Shape,pressedKey[n]>0?(drect[n].graphics.setStrokeStyle(t/2,"round","round",t).beginStroke(coloredKey[n]).beginFill(baseColor).drawRect(rects[n].x+t/3,rects[n].y+t/3,rects[n].w-2*t/3,rects[n].h-2*t/3),mobile||IE||(drect[n].shadow=new createjs.Shadow(coloredKey[n],0,0,2*t))):drect[n].graphics.setStrokeStyle(4*t/5,"round","round",t).beginStroke(strokeColor).beginFill(baseColor).drawRect(rects[n].x+t/2,rects[n].y+t/2,rects[n].w-t,rects[n].h-t),stage.addChild(drect[n]);for(n=0;n<chain;n++)cirs[n]={x:rects[(n+1)*keyX-1].x+rects[0].w+t/2,y:rects[(n+1)*keyX-1].y,w:rects[(n+1)*keyX-1].w,h:rects[(n+1)*keyX-1].h},cirs2[n]={x:cirs[n].x+rects[0].w/2,y:cirs[n].y+rects[0].h/2,w:(cirs[n].w-t/2)/2,h:(cirs[n].w-t/2)/2},stage.removeChild(dcir[n]),dcir[n]=new createjs.Shape,dcir[n].graphics.setStrokeStyle(t/2),nowPage==n?(dcir[n].graphics.beginStroke("rgba(50,200,200,0.65)"),dcir[n].shadow=new createjs.Shadow("rgba(50,200,200,0.65)",0,0,2*t)):dcir[n].graphics.beginStroke(strokeColor),dcir[n].graphics.beginFill(baseColor).drawCircle(cirs[n].x+rects[0].w/2,cirs[n].y+rects[0].h/2,(cirs[n].w-t/2)/2),stage.addChild(dcir[n]);stage.update()}}function animate(){for(var e=(canvas.width>canvas.height?canvas.height:canvas.width)/(keyX*keyY),t=0;t<rects.length;t++)stage.removeChild(anim[t]),pressedKey[t]>0&&(anim[t]=new createjs.Shape,anim[t].graphics.setStrokeStyle(e/2,"round","round",e).beginStroke(coloredKey[t]).beginFill("transparent").drawRect(rects[t].x+e/3,rects[t].y+e/3,rects[t].w-2*e/3,rects[t].h-2*e/3),anim[t].shadow=new createjs.Shadow(coloredKey[t],0,0,2*e),stage.addChild(anim[t]));stage.update()}function animatecanv(e){var t=(canvas.width>canvas.height?canvas.height:canvas.width)/(keyX*keyY);e<rects.length&&(ctx.clearRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),ctx.fillStyle="#444444",ctx.lineJoin="round",ctx.lineWidth=t/(.15*keyY),ctx.fillRect(rects[e].x,rects[e].y,rects[e].w,rects[e].h),ctx.strokeStyle=strokeColor,ctx.fillStyle=baseColor,ctx.strokeRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),ctx.fillRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),pressedKey[e]>0&&(ctx.lineJoin="round",ctx.lineWidth=t/(.25*keyY),ctx.strokeStyle=coloredKey[e],ctx.strokeRect(rects[e].x+t/3,rects[e].y+t/3,rects[e].w-2*t/3,rects[e].h-2*t/3)))}function Touched(e){var t;for(t=e.touches,ii=0;ii<t.length;ii++)collides(t[ii].pageX,t[ii].pageY),collides2(t[ii].pageX,t[ii].pageY)}function Clicked(e){collides(e.offsetX,e.offsetY),collides2(e.offsetX,e.offsetY)}function playAudio(e,t){audio[e][t][counter[e][t]]&&(sound[e][t][counter[e][t]].currentTime=0,sound[e][t][counter[e][t]].play(),counter[e][t]=(counter[e][t]+1)%keyCount[e][t])}function LoadingStatus(){document.getElementById("Info").innerTex="Info:Loading",document.getElementById("KeySound").innerText="KeySound:Loading",document.getElementById("LEDList").innerText="LEDList:Loading",document.getElementById("AutoData").innerText="AutoData:Loading"}function setProject(){stopT(),projectName="Projects/"+songs[select.selectedIndex],nowPage=0,LoadingStatus(),getData(projectName+"/info",function(e){setInfo(e.msg),initBtnEL(),getData(projectName+"/keySound",function(e){setKey(e.msg)}),getData(projectName+"/LEDList",function(e){setLED(e.msg)}),autoData.length=0,keyColor.length=0;for(var t=0;t<velocity.length;t++)velocity[t]=velocity[t].replace(/\./gi,","),keyColor[t]="rgba("+velocity[t]+opacity;getData(projectName+"/autoPlay",function(e){autoData=e.msg,document.getElementById("AutoData").innerText="AutoData:Loaded"})})}function setInfo(e){for(var t=0;t<e.length;t++){var n=e[t].split("=");"chain"==n[0]&&(chain=parseInt(n[1])),"buttonX"==n[0]&&(keyX=parseInt(n[1])),"buttonY"==n[0]&&(keyY=parseInt(n[1]))}arrinit(),stage.removeAllChildren(),stage.clear(),render(),document.getElementById("Info").innerText="Info:Loaded"}function setKey(e){for(var t=0;t<e.length;t++){var n=e[t].split(" ");if(4==n.length){var o=parseInt(n[0])-1,r=(parseInt(n[1])-1)*keyY+(parseInt(n[2])-1);sound[o][r].push(new Audio("Server/"+projectName+"/sounds/"+n[3])),audio[o][r][keyCount[o][r]]=n[3],keyCount[o][r]++}}document.getElementById("KeySound").innerText="KeySound:Loaded"}function setLED(e){for(var t=0;t<e.length;t++)!function(t){var n=e[t].split(" ");getData(projectName+"/keyLED/"+e[t],function(e){var t=parseInt(n[0])-1,o=(parseInt(n[1])-1)*keyX+(parseInt(n[2])-1);keyTest[t][o].push(e.msg);var r=keyTest[t][o].length-1;for(ir=0;ir<parseInt(n[3])-1;ir++)keyTest[t][o][r]=keyTest[t][o][r].concat(e.msg)})}(t);document.getElementById("LEDList").innerText="LEDList:Loaded"}window.addEventListener("keydown",function(e){keysDown[e.keyCode]=!0}),window.addEventListener("keyup",function(e){delete keysDown[e.keyCode]}),window.addEventListener("keydown",function(e){if(keyList.indexOf(e.keyCode)>-1){if(audio[nowPage][keyList.indexOf(e.keyCode)][counter[nowPage][keyList.indexOf(e.keyCode)]]){var t=keyList.indexOf(e.keyCode);keyTest[nowPage][t].length>0&&keyLED1(nowPage,t,counter[nowPage][t],0),playAudio(nowPage,t)}e.preventDefault()}},!1);var sList=[],lstring=[],ablob=[],dirs=[];function handleFile(e){e.name,new Date;JSZip.loadAsync(e).then(function(e){new Date;e.forEach(function(e,t){"info"==t.name.toLowerCase()?t.async("string").then(function(e){setInfo(e.split("\n"))}):"autoplay"==t.name.toLowerCase()?t.async("string").then(function(e){autoData=e.split("\n"),document.getElementById("AutoData").innerText="AutoData:Loaded"}):"keysound"==t.name.toLowerCase()&&t.async("string").then(function(e){sList=e.split("\n")}),1==t.dir&&dirs.push(e.replace(/\//gi,""))});for(var t=0;t<dirs.length;t++)"sounds"==dirs[t].toLowerCase()?e.folder(dirs[t]).forEach(function(t,n){e.file(n.name).async("blob").then(function(e){ablob[0].push(t),ablob[1].push(URL.createObjectURL(e))})}):"keyled"==dirs[t].toLowerCase()&&e.folder(dirs[t]).forEach(function(t,n){e.file(n.name).async("string").then(function(e){1==t.split(".").length&&(lstring[0].push(t),lstring[1].push(e))})})})}function setKeyZip(e){for(var t=0;t<e.length;t++){var n=e[t].split(" ");if(4==n.length){var o=parseInt(n[0])-1,r=(parseInt(n[1])-1)*keyY+(parseInt(n[2])-1),a=ablob[0].indexOf(n[3].replace(/\r/gi,""));a>-1&&(audio[o][r][keyCount[o][r]]=ablob[0][a],sound[o][r].push(new Audio(ablob[1][a])),keyCount[o][r]++)}}document.getElementById("KeySound").innerText="KeySound:Loaded"}function setLEDZip(e){for(var t=0;t<e[0].length;t++){var n=e[0][t].split(" "),o=e[1][t].split("\n"),r=parseInt(n[0])-1,a=(parseInt(n[1])-1)*keyX+(parseInt(n[2])-1);keyTest[r][a].push(o);var i=keyTest[r][a].length-1;for(ir=0;ir<parseInt(n[3])-1;ir++)keyTest[r][a][i]=keyTest[r][a][i].concat(o)}document.getElementById("LEDList").innerText="LEDList:Loaded"}function setProjectFile(){stopT(),nowPage=0,LoadingStatus(),autoData.length=0,keyColor.length=0;for(var e=0;e<velocity.length;e++)velocity[e]=velocity[e].replace(/\./gi,","),keyColor[e]="rgba("+velocity[e]+opacity;for(var t=document.getElementById("zipUp"),n=0;n<t.files.length;n++)handleFile(t.files[n]);render()}function setTest(){setKeyZip(sList),setLEDZip(lstring)}function getData(e,t){var n=JSON.stringify(e);jQuery.ajax({url:url,data:{msg:n},dataType:"jsonp",success:function(e){t(e)}})}function auto(){stopT(),autoP=!0,autoProcess(0)}function autoProcess(e){var t=0;if(e<autoData.length&&autoData.length>0&&autoP){var n=autoData[e].split(" "),o=n[0].toLowerCase();if("c"==o||"chain"==o)nowPage=parseInt(n[1])-1,render();else if("d"==o||"delay"==o)t+=parseInt(n[1]);else if("o"==o||"on"==o){var r=(parseInt(n[1])-1)*keyY+(parseInt(n[2])-1);keyTest[nowPage][r].length>0&&keyLED1(nowPage,r,counter[nowPage][r],0),playAudio(nowPage,r)}--t<0&&(t=0),t>=1?setTimeout(autoProcess,t,++e):autoProcess(++e)}else stopT()}function onLED(e,t){pressedKey[t]=1,coloredKey[t]=keyColor[120],(mobile||IE)&&requestAnimationFrame(function(){animatecanv(t)})}function onLED2(e,t,n){pressedKey[t]=1,parseInt(n)<keyColor.length?coloredKey[t]=keyColor[parseInt(n)]:coloredKey[t]=s2c(n),(mobile||IE)&&requestAnimationFrame(function(){animatecanv(t)})}function offLED(e,t){pressedKey[t]=0,(mobile||IE)&&requestAnimationFrame(function(){animatecanv(t)})}function keyLED1(e,t,n,o){var r=0,a=keyTest[e][t][n];if(void 0===a&&(n=0),a=keyTest[e][t][n][o],o<keyTest[e][t][n].length){var i=a.split(" "),s=i[0].toLowerCase();i.length>0&&("d"==s||"delay"==s?r+=parseInt(i[1]):"o"==s||"on"==s?"a"==i[3].toLowerCase()||"auto"==i[3].toLowerCase()?onLED2(e,(parseInt(i[1])-1)*keyY+(parseInt(i[2])-1),i[4]):onLED2(e,(parseInt(i[1])-1)*keyY+(parseInt(i[2])-1),i[3]):"f"!=s&&"off"!=s||offLED(e,(parseInt(i[1])-1)*keyY+(parseInt(i[2])-1))),--r<0&&(r=0),r>=1?st=setTimeout(keyLED1,r,e,t,n,o+1):keyLED1(e,t,n,o+1)}}function stopT(){clearTimeout(st),autoP=!1,initz(),render()}function s2c(e){for(var t=0,n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);var o="#";for(n=0;n<3;n++){o+=("00"+(t>>8*n&255).toString(16)).substr(-2)}return o}function arrinit(){ablob.length=0,lstring.length=0,sList.length=0,lstring=[],(ablob=[])[0]=[],ablob[1]=[],lstring[0]=[],lstring[1]=[],sound.length=0,audio.length=0,pressedKey.length=0,coloredKey.length=0,keyCount.length=0,counter.length=0,keyTest.length=0,audioInstance.length=0,anim.length=0,drect.length=0,dcir.length=0,rects.length=0,cirs.length=0,cirs2.length=0;for(var e=0;e<chain;e++){sound[e]=[],audio[e]=[],coloredKey[e]=[],keyCount[e]=[],counter[e]=[],keyTest[e]=[];for(var t=0;t<keyX*keyY;t++)sound[e][t]=[],audio[e][t]=[],pressedKey[t]=0,coloredKey[t]="#FF0000",keyCount[e][t]=0,counter[e][t]=0,keyTest[e][t]=[]}}function initz(){pressedKey.fill(0),coloredKey.fill(strokeColor)}