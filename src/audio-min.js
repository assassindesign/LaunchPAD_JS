var velocity,select,songs,LEDList,canvas,projectName,timer,stage,st,keyList=[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,49,50,51,52,53,54,55,56,57,48,32,96,97,98,99,100,101,102,103,104,105,111,106,109,107,110,189,187,8,219,221,220,186,222,188,190,191,192,16],url="http://127.0.0.1:9000",mobile=!1,opacity=",1)",keyColor=[],pressedKey=[],coloredKey=[],oriPressedKey=[],oriColoredKey=[],keyCount=[],counter=[],baseColor="#FFFFFF",strokeColor="rgba(255,255,255,0.6)",sound=[],audio=[],audioInstance=[],autoData=[],cirs=[],cirs2=[],rects=[],anim=[],nowPage=0,chain=6,keyX=8,keyY=8,autoP=!1,keyTest=[];function cnv2Resize(){canvas.width=19*window.innerWidth/20,canvas.height=19*window.innerHeight/20,initBtnEL(),render()}function initBtnEL(){mobile?(canvas.removeEventListener("touchstart",Touched),canvas.addEventListener("touchstart",Touched)):(canvas.removeEventListener("click",Clicked,!1),canvas.addEventListener("click",Clicked,!1))}function collides(e,t){for(var n=!1,o=0,a=rects.length;o<a;o++){var r=rects[o].x,i=rects[o].x+rects[o].w,s=rects[o].y,c=rects[o].y+rects[o].h;if(i>=e&&r<=e&&c>=t&&s<=t){if(n=rects[o],!audio[nowPage][o][counter[nowPage][o]])return null;keyTest[nowPage][o].length>0&&keyLED1(o,counter[nowPage][o],0),playAudio(nowPage,o)}}return n}function collides2(e,t){for(var n=!1,o=0,a=cirs.length;o<a;o++){var r=cirs[o].x,i=cirs[o].x+cirs[o].w,s=cirs[o].y,c=cirs[o].y+cirs[o].h;i>=e&&r<=e&&c>=t&&s<=t&&(n=cirs[o],nowPage=o,initz())}return n}Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),n=t.length>>>0,o=arguments[1]>>0,a=o<0?Math.max(n+o,0):Math.min(o,n),r=arguments[2],i=void 0===r?n:r>>0,s=i<0?Math.max(n+i,0):Math.min(i,n);a<s;)t[a]=e,a++;return t}}),$(function(){navigator.platform&&(0>"win16|win32|win64|mac".indexOf(navigator.platform.toLowerCase())?(mobile=!0,document.getElementById("Env").innerText="Mobile"):(mobile=!1,document.getElementById("Env").innerText="PC",createjs.Ticker.on("tick",animate),createjs.Ticker.framerate=48)),canvas=document.getElementById("canv"),ctx=canvas.getContext("2d"),stage=new createjs.Stage("canv"),select=document.getElementById("Selector"),getData("./Songs",function(e){songs=e.msg;for(var t=0;t<songs.length;t++){var n=document.createElement("option");n.value=t,n.text=songs[t].split("\n")[0],select.add(n)}}),getData("./Velocity",function(e){velocity=e.msg,document.getElementById("Velocity").innerText="Velocity:Loaded"}),arrinit()}),window.onload=function(){cnv2Resize(),window.addEventListener("resize",function(){clearTimeout(timer),timer=setTimeout(cnv2Resize,300)},!1)};var keysDown={};function render(){if(canvas&&stage){stage.removeAllChildren(),stage.clear();var e=canvas.width>canvas.height?canvas.height:canvas.width,t=e/(keyX*keyY);bg=new createjs.Shape,bg.graphics.beginFill("#444444"),bg.graphics.drawRoundRect(t/2,t/2,canvas.width-t,canvas.height-t,t),stage.addChild(bg);for(var n=0;n<keyX*keyY;n++)rects[n]={x:canvas.width/2-keyX/2*e/(keyX+1)+e*(n%keyX)/(keyX+2),y:canvas.height/2-keyY/2*e/(keyY+2)+e*parseInt(n/keyY)/(keyY+2),w:e/(keyX+3),h:e/(keyY+3)};for(n=0;n<chain;n++)cirs[n]={x:rects[(n+1)*keyX-1].x+rects[0].w+t/2,y:rects[(n+1)*keyX-1].y,w:rects[(n+1)*keyX-1].w,h:rects[(n+1)*keyX-1].h},cirs2[n]={x:cirs[n].x+rects[0].w/2,y:cirs[n].y+rects[0].h/2,w:(cirs[n].w-t/2)/2,h:(cirs[n].w-t/2)/2};for(n=0;n<rects.length;n++){var o=new createjs.Shape;o.graphics.setStrokeStyle(4*t/5,"round","round",t),o.graphics.beginStroke(strokeColor),o.graphics.beginFill(baseColor),o.graphics.drawRect(rects[n].x+t/2,rects[n].y+t/2,rects[n].w-t,rects[n].h-t),stage.addChild(o)}for(n=0;n<chain;n++){var a=new createjs.Shape;a.graphics.setStrokeStyle(t/2),a.graphics.beginStroke(strokeColor),nowPage==n?a.graphics.beginFill("rgba(0,255,255,0.75)"):a.graphics.beginFill(baseColor),a.graphics.drawCircle(cirs[n].x+rects[0].w/2,cirs[n].y+rects[0].h/2,(cirs[n].w-t/2)/2),stage.addChild(a)}stage.update()}}function animate(){for(var e=(canvas.width>canvas.height?canvas.height:canvas.width)/(keyX*keyY),t=0;t<rects.length;t++)stage.removeChild(anim[t]),pressedKey[nowPage][t]>0&&(anim[t]=new createjs.Shape,anim[t].graphics.setStrokeStyle(e/2,"round","round",e).beginStroke(coloredKey[nowPage][t]).beginFill("transparent").drawRect(rects[t].x+e/3,rects[t].y+e/3,rects[t].w-2*e/3,rects[t].h-2*e/3),anim[t].shadow=new createjs.Shadow(coloredKey[nowPage][t],0,0,2*e),stage.addChild(anim[t]));stage.update()}function animatecanv(e){var t=(canvas.width>canvas.height?canvas.height:canvas.width)/(keyX*keyY);e<rects.length&&(ctx.clearRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),ctx.fillStyle="#444444",ctx.lineJoin="round",ctx.lineWidth=t/(.15*keyY),ctx.fillRect(rects[e].x,rects[e].y,rects[e].w,rects[e].h),ctx.strokeStyle=strokeColor,ctx.fillStyle=baseColor,ctx.strokeRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),ctx.fillRect(rects[e].x+t/2,rects[e].y+t/2,rects[e].w-t,rects[e].h-t),pressedKey[nowPage][e]>0&&(ctx.lineJoin="round",ctx.lineWidth=t/(.25*keyY),ctx.strokeStyle=coloredKey[nowPage][e],ctx.strokeRect(rects[e].x+t/3,rects[e].y+t/3,rects[e].w-2*t/3,rects[e].h-2*t/3)))}function Touched(e){var t;for(t=e.touches,ii=0;ii<t.length;ii++)collides(t[ii].pageX,t[ii].pageY),collides2(t[ii].pageX,t[ii].pageY)}function Clicked(e){collides(e.offsetX,e.offsetY),collides2(e.offsetX,e.offsetY)}function playAudio(e,t){audio[e][t][counter[e][t]]&&(createjs.Sound.play(audio[e][t][counter[e][t]],0,0,0),counter[e][t]=(counter[e][t]+1)%keyCount[e][t])}function LoadingStatus(){document.getElementById("Info").innerTex="Info:Loading",document.getElementById("KeySound").innerText="KeySound:Loading",document.getElementById("LEDList").innerText="LEDList:Loading",document.getElementById("AutoData").innerText="AutoData:Loading"}function setProject(){stopT(),projectName=songs[select.selectedIndex],nowPage=0,LoadingStatus(),rects.length=0,cirs.length=0,cirs2.length=0,getData(projectName+"/info",function(e){info=e.msg;for(var t=0;t<info.length;t++){var n=info[t].split("=");"chain"==n[0]&&(chain=parseInt(n[1])),"buttonX"==n[0]&&(keyX=parseInt(n[1])),"buttonY"==n[0]&&(keyY=parseInt(n[1]))}arrinit(),document.getElementById("Info").innerText="Info:Loaded",initBtnEL(),getData(projectName+"/keySound",function(e){for(var t=e.msg,n=0;n<t.length;n++){var o=t[n].split(" ");if(4==o.length){var a=parseInt(o[0])-1,r=(parseInt(o[1])-1)*keyY+(parseInt(o[2])-1);sound[a][r].push(projectName+"/sounds/"+o[3]),audio[a][r][keyCount[a][r]]=o[3],createjs.Sound.registerSound(sound[a][r][keyCount[a][r]],audio[a][r][keyCount[a][r]],1),keyCount[a][r]++}}document.getElementById("KeySound").innerText="KeySound:Loaded"}),getData(projectName+"/LEDList",function(e){LEDList=e.msg;for(var t=0;t<LEDList.length;t++)!function(e){var t=LEDList[e].split(" ");getData(projectName+"/keyLED/"+LEDList[e],function(e){var n=parseInt(t[0])-1,o=(parseInt(t[1])-1)*keyX+(parseInt(t[2])-1);keyTest[n][o].push(e.msg);var a=keyTest[n][o].length-1;for(ir=0;ir<parseInt(t[3])-1;ir++)keyTest[n][o][a]=keyTest[n][o][a].concat(e.msg)})}(t);document.getElementById("LEDList").innerText="LEDList:Loaded"}),autoData.length=0,keyColor.length=0;for(var o=0;o<velocity.length;o++)velocity[o]=velocity[o].replace(/\./gi,","),keyColor[o]="rgba("+velocity[o]+opacity;getData(projectName+"/autoPlay",function(e){autoData=e.msg,document.getElementById("AutoData").innerText="AutoData:Loaded"}),oriPressedKey.length=0,oriColoredKey.length=0;for(t=0;t<chain;t++){oriPressedKey[t]=[],oriColoredKey[t]=[];for(var a=0;a<keyX*keyY;a++)oriPressedKey[t][a]=0,oriColoredKey[t][a]=strokeColor}stopT()})}function getData(e,t){var n=JSON.stringify(e);jQuery.ajax({url:url,data:{msg:n},dataType:"jsonp",success:function(e){t(e)}})}function auto(){stopT(),autoP=!0,autoProcess(0)}function autoProcess(e){var t=0;if(e<autoData.length&&autoData.length>0&&autoP){var n=autoData[e].split(" "),o=n[0].toLowerCase();if("c"==o||"chain"==o)nowPage=parseInt(n[1])-1,initz();else if("d"==o||"delay"==o)t+=parseInt(n[1]);else if("o"==o){var a=(parseInt(n[1])-1)*keyY+(parseInt(n[2])-1);keyTest[nowPage][a].length>0&&keyLED1(a,counter[nowPage][a],0),playAudio(nowPage,a)}else"f"==o&&t--;t<0&&(t=0),t>=1?setTimeout(autoProcess,t,++e):autoProcess(++e)}}function onLED(e,t){pressedKey[e][t]=1,mobile&&requestAnimationFrame(function(){animatecanv(t)})}function onLED2(e,t,n){pressedKey[e][t]=1,parseInt(n)<keyColor.length?coloredKey[e][t]=keyColor[parseInt(n)]:coloredKey[e][t]=s2c(n),mobile&&requestAnimationFrame(function(){animatecanv(t)})}function offLED(e,t){pressedKey[e][t]=0,mobile&&requestAnimationFrame(function(){animatecanv(t)})}function keyLED1(e,t,n){var o=0,a=keyTest[nowPage][e][t];if(void 0===a&&(t=0),a=keyTest[nowPage][e][t][n],n<keyTest[nowPage][e][t].length){var r=a.split(" "),i=r[0].toLowerCase();r.length>0&&("d"==i||"delay"==i?o+=parseInt(r[1]):"o"==i||"on"==i?"a"==r[3].toLowerCase()||"auto"==r[3].toLowerCase()?onLED2(nowPage,(parseInt(r[1])-1)*keyY+(parseInt(r[2])-1),r[4]):onLED2(nowPage,(parseInt(r[1])-1)*keyY+(parseInt(r[2])-1),r[3]):"f"!=i&&"off"!=i||offLED(nowPage,(parseInt(r[1])-1)*keyY+(parseInt(r[2])-1))),--o<0&&(o=0),o>=1?st=setTimeout(keyLED1,o,e,t,n+1):keyLED1(e,t,n+1)}}function keyLED2(e,t){var n=keyTest[nowPage][e][counter[nowPage][e]][t];if(t<keyTest[nowPage][e][counter[nowPage][e]].length&&n.length>0){var o=n.split(" "),a=o[0].toLowerCase();o.length>0&&("o"!=a&&"f"!=a&&"on"!=a&&"off"!=a||offLED(nowPage,(parseInt(o[1])-1)*keyY+(parseInt(o[2])-1))),keyLED2(e,t+1)}}function stopT(){clearTimeout(st),autoP=!1,initz()}function s2c(e){for(var t=0,n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);var o="#";for(n=0;n<3;n++){o+=("00"+(t>>8*n&255).toString(16)).substr(-2)}return o}function arrinit(){sound.length=0,audio.length=0,pressedKey.length=0,coloredKey.length=0,keyCount.length=0,counter.length=0,keyTest.length=0,audioInstance.length=0,anim.length=0;for(var e=0;e<chain;e++){sound[e]=[],audio[e]=[],pressedKey[e]=[],coloredKey[e]=[],keyCount[e]=[],counter[e]=[],keyTest[e]=[];for(var t=0;t<keyX*keyY;t++)sound[e][t]=[],audio[e][t]=[],pressedKey[e][t]=0,coloredKey[e][t]="#FF0000",keyCount[e][t]=0,counter[e][t]=0,keyTest[e][t]=[]}}function initz(){pressedKey[nowPage].fill(0),coloredKey[nowPage].fill(strokeColor),render()}window.addEventListener("keydown",function(e){keysDown[e.keyCode]=!0}),window.addEventListener("keyup",function(e){delete keysDown[e.keyCode]}),window.addEventListener("keydown",function(e){if(keyList.indexOf(e.keyCode)>-1){if(audio[nowPage][keyList.indexOf(e.keyCode)][counter[nowPage][keyList.indexOf(e.keyCode)]]){var t=keyList.indexOf(e.keyCode);keyTest[nowPage][t].length>0&&keyLED1(t,counter[nowPage][t],0),playAudio(nowPage,t)}e.preventDefault()}},!1);